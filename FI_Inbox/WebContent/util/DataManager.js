/*
 * Copyright (C) 2009-2015 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.ui.utils.busydialog");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("cross.fnd.fiori.inbox.util.Substitution");sap.ui.base.EventProvider.extend("cross.fnd.fiori.inbox.util.DataManager",{sMode:"TABLET",oModel:null,oPostActionModel:null,oDecisionOptions:{},oBaseController:null,_oScenarioConfig:null,FUNCTION_IMPORT_CONFIRM:"Confirm",FUNCTION_IMPORT_DECISION:"Decision",FUNCTION_IMPORT_DECISIONOPTIONS:"DecisionOptions",FUNCTION_IMPORT_RESUBMIT:"Resubmit",FUNCTION_IMPORT_ENABLESUBSTITUTIONRULE:"EnableSubstitutionRule",aSystemInfoCollection:null,aSubstitutionProfilesCollection:null,sScenarioId:null,bAllItems:null,bOutbox:false,bIsMassActionEnabled:null,bIsQuickActionEnabled:null,sDefaultSortBy:null,iListSize:100,sCustomAttributeDefinitionNavProperty:"CustomAttributeDefinitionData",sClaimAction:"Claim",sReleaseAction:"Release",sResumeAction:"CancelResubmission",sTaskDefinitionCollectionName:"TaskDefinitionCollection",sStatusCompleted:"COMPLETED",constructor:function(m,b){sap.ui.base.EventProvider.apply(this);this.oBaseController=b;if(this.oBaseController.getOwnerComponent().getComponentData()){var s=this.oBaseController.getOwnerComponent().getComponentData().startupParameters;if(s){if(s.scenarioId&&s.scenarioId.length>0){this.sScenarioId=s.scenarioId[0];}if(s.allItems&&s.allItems.length>0){this.bAllItems=s.allItems[0]=="true"?true:false;}if(s.outbox&&s.outbox.length>0){this.bOutbox=s.outbox[0]=="true"?true:false;}if(s.massAction&&s.massAction.length>0){if(s.massAction[0]=="true"){this.bIsMassActionEnabled=true;}else if(s.massAction[0]=="false"){this.bIsMassActionEnabled=false;}}if(s.quickAction&&s.quickAction.length>0){if(s.quickAction[0]=="true"){this.bIsQuickActionEnabled=true;}else if(s.quickAction[0]=="false"){this.bIsQuickActionEnabled=false;}}if(s.sortBy&&s.sortBy.length>0){this.sDefaultSortBy=s.sortBy[0];}if(s.listSize&&s.listSize.length>0){this.iListSize=s.listSize[0];}if(s.taskObjects&&s.taskObjects.length>0){this.bShowTaskObjects=s.taskObjects[0]=="true"?true:false;}else{this.bShowTaskObjects=sap.ui.Device.system.desktop;}}}else{this.sScenarioId=jQuery.sap.getUriParameters().get("scenarioId");this.bAllItems=jQuery.sap.getUriParameters().get("allItems")=="true"?true:false;this.bOutbox=jQuery.sap.getUriParameters().get("outbox")=="true"?true:false;if(jQuery.sap.getUriParameters().get("massAction")=="true"){this.bIsMassActionEnabled=true;}else if(jQuery.sap.getUriParameters().get("massAction")=="false"){this.bIsMassActionEnabled=false;}if(jQuery.sap.getUriParameters().get("quickAction")=="true"){this.bIsQuickActionEnabled=true;}else if(jQuery.sap.getUriParameters().get("quickAction")=="false"){this.bIsQuickActionEnabled=false;}this.sDefaultSortBy=jQuery.sap.getUriParameters().get("sortBy");if(jQuery.sap.getUriParameters().get("listSize")>0){this.iListSize=jQuery.sap.getUriParameters().get("listSize");}var t=jQuery.sap.getUriParameters().get("taskObjects");if(t&&t.length>0){this.bShowTaskObjects=t==="true"?true:false;}else{this.bShowTaskObjects=sap.ui.Device.system.desktop;}}this.oModel=m;if(this.oModel){this.oModel.setUseBatch(true);}this.oPostActionModel=this.oBaseController.getView().getModel("POSTACTION");this.oi18nResourceBundle=sap.ca.scfld.md.app.Application.getImpl().AppI18nModel.getResourceBundle();this.bDetailPageLoaded=false;if(this.bOutbox){this.iListSize=300;}},handleRequestFailed:function(e){if(e){var r=e.getParameter("url");if(r&&r.split("?")[0]==="TaskCollection"){this.handleTaskCollectionFailed(e);}}this.fnShowReleaseLoader(false);},handleTaskCollectionFailed:function(e){var d=e.getParameter("response")?e.getParameter("response").responseText:"";var E={customMessage:{message:this.oi18nResourceBundle.getText("dialog.error.task_collection"),details:d}};this.oDataRequestFailed(E);this.oBaseController.removeHeaderFooterOptions();this.oListView.setBusy(false);var l=this.oListView.byId("list");if(l)l.setEnableBusyIndicator(false);if(this.detailPage)this.detailPage.setBusy(false);},attachItemRemoved:function(d,f,l){this.attachEvent(cross.fnd.fiori.inbox.util.DataManager.M_EVENTS.ItemRemoved,d,f,l);return this;},fireItemRemoved:function(a){this.fireEvent(cross.fnd.fiori.inbox.util.DataManager.M_EVENTS.ItemRemoved,a);return this;},loadInitialAppData:function(s){if(!this.sScenarioId||!this.oModel){return null;}var t=this;var f="(ConsumerType eq '"+jQuery.sap.encodeURL(this.sMode)+"') and (UniqueName eq '"+jQuery.sap.encodeURL(this.sScenarioId)+"')";var S=function(d){t.fnShowReleaseLoader(false);if(d.hasOwnProperty("__batchResponses")&&d.__batchResponses.length==2){var E=[];var F=d.__batchResponses[0];if(F.hasOwnProperty("data")&&F.statusCode>='200'&&F.statusCode<'300'){t._processFilterOptionsResult(F.data);}else if(F.hasOwnProperty("response")&&F.response.statusCode>='400'){E.push(JSON.parse(F.response.body));}var c=d.__batchResponses[1];if(c.hasOwnProperty("data")&&c.statusCode>='200'&&c.statusCode<'300'){s(t._processConsumerScenarioResult(c.data));}else if(c.hasOwnProperty("response")&&c.response.statusCode>='400'){E.push(JSON.parse(c.response.body));}t._handleBatchErrors(E);}};var e=function(E){t.fnShowReleaseLoader(false);t.oDataRequestFailed(E);};t.fnShowReleaseLoader(true);var r=["/FilterOptionCollection","/ConsumerScenarioCollection"];t.fireBatch({aPaths:r,aUrlParameters:["","$filter="+encodeURIComponent(f)],sMethod:"GET",sBatchGroupId:"FilterOptionsAndConsumerScenarioCollection",numberOfRequests:r.length,fnSuccessCallback:S,fnErrorCallback:e});},fireBatch:function(p){this.oModel.setDeferredBatchGroups([p.sBatchGroupId]);var P;var e={batchGroupId:p.sBatchGroupId};for(var i=0;i<p.numberOfRequests;i++){if(p.aUrlParameters){e.urlParameters=p.aUrlParameters[i];}if(p.aProperties){e.properties=p.aProperties[i];}if(p.sPath){P=p.sPath;}else if(p.aPaths){P=p.aPaths[i];}if(!jQuery.sap.startsWith(P,"/")){P="/"+P;}if(p.sMethod=="GET"){this.oModel.read(P,e);}else if(p.sMethod=="POST"){e.changeSetId="changeSetId"+i;this.oModel.createEntry(P,e);}else if(p.sMethod=="DELETE"){e.changeSetId="changeSetId"+i;this.oModel.remove(P,e);}else if(p.sMethod=="FUNCTIONIMPORT"){e.changeSetId="changeSetId"+i;e.method="POST";this.oModel.callFunction(P,e);}}this.oModel.submitChanges({batchGroupId:p.sBatchGroupId,success:p.fnSuccessCallback,error:p.fnErrorCallback});},_handleBatchErrors:function(e,c){if(e.length>0){if(c){var d="";jQuery.each(e,$.proxy(function(f,E){if(d.localeCompare(this.getErrorMessage(E)+"\n"))d+=this.getErrorMessage(E)+"\n";},this));var E={customMessage:{message:c,details:d}};}else{var m="";var b="";for(var i=0;i<e.length;i++){if(e[i].hasOwnProperty("error")){m+=e[i].error.message.value;}else if(e[i].hasOwnProperty("response")){m+=e[i].message;var a=JSON.parse(e[i].response.body);b+=a.error.message.value+"\n";}if(i<e.length-1){m+="\n";}}var E={message:m,response:{body:b}};}this.oDataRequestFailed(E);}},processListAfterAction:function(o,i){this.oBaseController.findNextVisibleItem(o,i);this.oModel.bDataChangeProcessingRequired=true;if(this.oModel.bFullRefreshNeeded){this.oModel.refresh();this.fireItemRemoved();}else{this.fnRefreshSingleTaskData(o,i);}},clearDecisionOptionsCache:function(){this.oDecisionOptions={};},_processConsumerScenarioResult:function(d){if(d.results.length==0){this._scenarioRequestFailed();return;}var m=new RegExp(";o=([A-Z0-9_]+)/.+\\?\\$filter=(.+)");var f=new RegExp("TaskDefinitionID eq '(.+)'");var c={};var s={};jQuery.each(d.results,function(I,e){var S=s[e.UniqueName];if(!S){S=e;S.ScenarioServiceInfos=[];s[S.UniqueName]=S;}else{S.TotalItems=S.TotalItems+e.TotalItems;}var r=m.exec(e.ScenarioServiceURL);if(r){var o=r[1];var t=[];var F=r[2].split(" or ");for(var i=0;i<F.length;i++){r=f.exec(F[i]);if(r)t.push(r[1]);}if(t.length>0){var a={Origin:o,TaskDefinitionIDs:t};S.ScenarioServiceInfos.push(a);}}});jQuery.each(s,function(i,S){c=S;});this._oScenarioConfig=c;return c;},getScenarioConfig:function(){var c=this._oScenarioConfig;if(c==null){c={};}c.AllItems=this.bAllItems;if(this.bIsMassActionEnabled!=null){c.IsMassActionEnabled=this.bIsMassActionEnabled;}if(c.IsMassActionEnabled===undefined){c.IsMassActionEnabled=true;}if(this.bIsQuickActionEnabled!=null){c.IsQuickActionEnabled=this.bIsQuickActionEnabled;}if(c.IsQuickActionEnabled===undefined){c.IsQuickActionEnabled=true;}if(this.sDefaultSortBy!=null){c.SortBy=this.sDefaultSortBy;}if((!c.SortBy)&&(c.UniqueName===undefined)){c.SortBy="CreatedOn";}if((!c.DisplayName)&&(c.AllItems)){c.DisplayName=this.oi18nResourceBundle.getText("ALL_ITEMS_SCENARIO_DISPLAY_NAME");}return c;},getListSize:function(){return this.iListSize;},_scenarioRequestFailed:function(){var e={customMessage:{message:this.oi18nResourceBundle.getText("DataManager.scenarioReadFailed"),details:this.oi18nResourceBundle.getText("DataManager.scenarioReadFailedDetail")}};this.oDataRequestFailed(e);},sendMultiAction:function(I,d,n,o,a){var r=[];var p=[];var t=this;for(var i=0;i<I.length;i++){var b=I[i];var P="SAP__Origin='"+jQuery.sap.encodeURL(b.SAP__Origin)+"'&InstanceID='"+jQuery.sap.encodeURL(b.InstanceID)+"'&DecisionKey='"+jQuery.sap.encodeURL(d.DecisionKey)+"'";if(n&&n.length>0)P+="&Comments='"+jQuery.sap.encodeURL(n)+"'";r.push(this.FUNCTION_IMPORT_DECISION);p.push(P);}var s=function(D){t.fnShowReleaseLoader(false);var B=D.__batchResponses;var S=[];var E=[];for(var i=0;i<B.length;i++){var c=B[i];var b=I[i];var f=false;if(b){var g={SAP__Origin:b.SAP__Origin,InstanceID:b.InstanceID};}if(c.hasOwnProperty("__changeResponses")){var C=c.__changeResponses[0];if(C.statusCode>="200"&&C.statusCode<"300")f=true;}if(f){g.message=t.oi18nResourceBundle.getText("multi.processed");S.push(g);}else{if(c.response){g.message=JSON.parse(c.response.body).error.message.value;E.push(g);}}}if(o)o(S,E);};var e=function(E){t.fnShowReleaseLoader(false);t.oDataRequestFailed(E);if(a)a(E);};t.fnShowReleaseLoader(true);t.oModel.setRefreshAfterChange(false);t.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"POST",sBatchGroupId:"ImportDecisions",numberOfRequests:r.length,fnSuccessCallback:s,fnErrorCallback:e});},readDataOnTaskSelectionWithDecisionOptions:function(c,e,o,I,s){if(!c||!o||!I){return null;}var t=this;var d=[];var r=[];var p=[];var E="";r.push(c);for(var i=0;i<e.length;i++){if(E!==""){E=E+",";}E=E+e[i];}if(E!==""){p.push({$expand:E});}else{p.push("");}if(!this.oDecisionOptions[o+I]){var P={SAP__Origin:"'"+o+"'",InstanceID:"'"+I+"'"};r.push("/"+this.FUNCTION_IMPORT_DECISIONOPTIONS);p.push(P);t.bDecisionOptionsCached=false;}else{d=this.oDecisionOptions[o+I];t.bDecisionOptionsCached=true;}var S=function(D){t.bDetailPageLoaded=true;t.fnShowReleaseLoader(false);if(D.hasOwnProperty("__batchResponses")&&D.__batchResponses.length>=1){var T=jQuery.extend(true,{},D.__batchResponses[0]);if(T.hasOwnProperty("data")&&T.statusCode>='200'&&T.statusCode<'300'){var a=T.data;if((a.Status===t.sStatusCompleted)&&(this.bOutbox===false)){t._refreshListOnError(o,I);}else{if(!t.bDecisionOptionsCached){var b=D.__batchResponses[1];if(b.hasOwnProperty("data")&&b.statusCode>='200'&&b.statusCode<'300'){d=b.data.results;t.oDecisionOptions[o+I]=d;}else{jQuery.sap.log.error(t.oi18nResourceBundle.getText("console.error.decision_options"));}}s(a,d);}}else{t._refreshListOnError(o,I);}}};var f=function(a){t.fnShowReleaseLoader(false);t.oDataRequestFailed(a);};if(t.detailPage){t.detailPage.setBusyIndicatorDelay(0);t.detailPage.setBusy(true);};t.bDetailPageLoaded=false;t.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"GET",sBatchGroupId:"DetailWithDecisionOptions",numberOfRequests:r.length,fnSuccessCallback:S,fnErrorCallback:f});},readCustomAttributeDefinitionData:function(o,t,s){var a=this;var c="/"+a.sTaskDefinitionCollectionName+"(SAP__Origin='"+jQuery.sap.encodeURL(o)+"',TaskDefinitionID='"+jQuery.sap.encodeURL(t)+"')";var e={$expand:a.sCustomAttributeDefinitionNavProperty};var S=function(d,r){if(d.CustomAttributeDefinitionData.results.length==0){jQuery.sap.log.error("No definition found for Custom Attributes");return;}s(d);};var E=function(b){a.oDataRequestFailed(b);};this.oDataRead(c,e,S,E);},readDecisionOptions:function(o,i,a,b){if(this.oDecisionOptions[o+i]){if(a){a(this.oDecisionOptions[o+i]);}return;}var t=this;t.fnShowReleaseLoader(true);this.oDataRead("/"+this.FUNCTION_IMPORT_DECISIONOPTIONS,{SAP__Origin:"'"+o+"'",InstanceID:"'"+i+"'"},function(d,r){t.fnShowReleaseLoader(false);if(d&&d.results){t.oDecisionOptions[o+i]=d.results;if(a){a(d.results);}}},function(e){t.fnShowReleaseLoader(false);t.oDataRequestFailed(e);if(b){b(e);}});},_doReadDetail:function(c,e,I,s,E){var a;if(!I)var i=e.indexOf("Comments/CreatedByDetails");if(i>=0){e[i]="Comments";}a={$expand:e.join(",")};this.oDataRead(c,a,s,E);},readPotentialOwners:function(o,i,s,e){var t=this;t.fnShowLoaderInDialogs(true);this.oDataRead("/TaskCollection(SAP__Origin='"+jQuery.sap.encodeURL(o)+"',InstanceID='"+jQuery.sap.encodeURL(i)+"')/PotentialOwners",null,function(d,r){t.fnShowLoaderInDialogs(false);if(d){if(s){s(d);}}},function(E){t.fnShowLoaderInDialogs(false);t.oDataRequestFailed(E);if(e)e(E);});},readUserInfo:function(s,u,S,e,c){var t=this;if(!c){t.fnShowReleaseLoader(true);}this.oDataRead("/UserInfoCollection(SAP__Origin='"+jQuery.sap.encodeURL(s)+"',UniqueName='"+jQuery.sap.encodeURL(u)+"')",null,function(d,r){if(!c){t.fnShowReleaseLoader(false);}if(d){S(d);}},function(E){if(!c){t.fnShowReleaseLoader(false);}t.oDataRequestFailed(E);if(e)e(E);});},_processFilterOptionsResult:function(d){this.oPriorityMap={};this.oStatusMap={};var n;jQuery.each(d.results,$.proxy(function(i,e){if(e.Type=="PRIORITY"){if(!this.oPriorityMap.hasOwnProperty(e.SAP__Origin))this.oPriorityMap[e.SAP__Origin]={};n=this.oPriorityMap[e.SAP__Origin];n[e.TechnicalName]=e.DisplayName;}else if(e.Type=="STATUS"){if(!this.oStatusMap.hasOwnProperty(e.SAP__Origin))this.oStatusMap[e.SAP__Origin]={};n=this.oStatusMap[e.SAP__Origin];n[e.TechnicalName]=e.DisplayName;}},this));},getPriorityDisplayName:function(o,t){var n;if(o==null||t==null)throw"sOrigin and sTechnicalName mustn't be null";if(this.oPriorityMap&&this.oPriorityMap.hasOwnProperty(o)){n=this.oPriorityMap[o];if(n.hasOwnProperty(t))return n[t];}return null;},getStatusDisplayName:function(o,t){var n;if(o==null||t==null)throw"sOrigin and sTechnicalName mustn't be null";if(this.oStatusMap&&this.oStatusMap.hasOwnProperty(o)){n=this.oStatusMap[o];if(n.hasOwnProperty(t))return n[t];}return null;},getErrorMessageKey:function(f){switch(f){case this.sReleaseAction:return"dialog.error.release";break;case this.sClaimAction:return"dialog.error.claim";break;case this.sResumeAction:return"dialog.error.resume";break;default:return"dialog.error.generic.action";}},sendAction:function(f,d,n,s,e){this.oModel.bFullRefreshNeeded=true;this.fnShowReleaseLoader(true);var E=this.oi18nResourceBundle.getText(this.getErrorMessageKey(f));var u={SAP__Origin:"'"+encodeURIComponent(d.SAP__Origin)+"'",InstanceID:"'"+(d.InstanceID)+"'"};if(d.DecisionKey){u.DecisionKey="'"+d.DecisionKey+"'";}if(n&&n.length>0){u.Comments="'"+n+"'";}this._performPost("/"+f,d.SAP__Origin,u,$.proxy(function(d,s){this.fnShowReleaseLoader(false);this.processListAfterAction(d.SAP__Origin,d.InstanceID);if(s){s();}},this,d,s),$.proxy(function(o){this.fnShowReleaseLoader(false);if(e){e(o);}},this),E);},doForward:function(o,i,u,n,s,e){this.oModel.bFullRefreshNeeded=true;var U={SAP__Origin:"'"+o+"'",InstanceID:"'"+i+"'",ForwardTo:"'"+u+"'",Comments:"'"+n+"'"};this._performPost("/Forward",o,U,$.proxy(function(){this.fnShowReleaseLoader(false);this.processListAfterAction(o,i);s();},this),$.proxy(function(){this.oModel.bFullRefreshNeeded=true;this.processListAfterAction(o,i);if(e){e();}},this),this.oi18nResourceBundle.getText("dialog.error.forward"));},doResubmit:function(o,i,r,s,e){var u="SAP__Origin="+"'"+o+"'"+"&InstanceID="+"'"+i+"'"+"&ResubmissionDate="+r;this._performPost("/"+this.FUNCTION_IMPORT_RESUBMIT,o,u,$.proxy(function(){this.oModel.bFullRefreshNeeded=true;this.processListAfterAction(o,i);s();},this),$.proxy(function(){this.oModel.bFullRefreshNeeded=true;this.processListAfterAction(o,i);if(e){e();}},this),this.oi18nResourceBundle.getText("dialog.error.resubmit"));},doMassForward:function(I,a,n,s,e){var r=[];var p=[];var t=this;for(var i=0;i<I.length;i++){var o=I[i];var P="/Forward";var b="SAP__Origin='"+jQuery.sap.encodeURL(o.SAP__Origin)+"'&InstanceID='"+jQuery.sap.encodeURL(o.InstanceID)+"'&ForwardTo='"+jQuery.sap.encodeURL(a.UniqueName)+"'";if(n&&n.length>0)b+="&Comments='"+jQuery.sap.encodeURL(n)+"'";r.push(P);p.push(b);}var S=function(d){t.fnShowReleaseLoader(false);var B=d.__batchResponses;var c=[];var f=[];for(var i=0;i<B.length;i++){var g=B[i];var o=I[i];var h=false;if(o){var j={SAP__Origin:o.SAP__Origin,InstanceID:o.InstanceID};}if(g.hasOwnProperty("__changeResponses")){var C=g.__changeResponses[0];if(C.statusCode>="200"&&C.statusCode<"300")h=true;}if(h){j.message=t.oi18nResourceBundle.getText("multi.processed");c.push(j);}else{if(g.response){j.message=JSON.parse(g.response.body).error.message.value;f.push(j);}}}if(s)s(c,f,a);};var E=function(c){t.fnShowReleaseLoader(false);t.oDataRequestFailed(c);if(e)e(c);};t.fnShowReleaseLoader(true);t.oModel.setRefreshAfterChange(false);t.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"POST",sBatchGroupId:"massForward",numberOfRequests:r.length,fnSuccessCallback:S,fnErrorCallback:E});},doMassResubmit:function(I,r,s,e){var R=[];var p=[];var t=this;for(var i=0;i<I.length;i++){var o=I[i];var P="/"+this.FUNCTION_IMPORT_RESUBMIT;var a="SAP__Origin='"+jQuery.sap.encodeURL(o.SAP__Origin)+"'&InstanceID='"+jQuery.sap.encodeURL(o.InstanceID)+"'&ResubmissionDate="+r;R.push(P);p.push(a);};var S=function(d){t.fnShowReleaseLoader(false);var b=d.__batchResponses;var c=[];var f=[];for(var i=0;i<b.length;i++){var B=b[i];var o=I[i];var g=false;if(o){var h={SAP__Origin:o.SAP__Origin,InstanceID:o.InstanceID};}if(B.hasOwnProperty("__changeResponses")){var C=B.__changeResponses[0];if(C.statusCode>="200"&&C.statusCode<"300")g=true;}if(g){h.message=t.oi18nResourceBundle.getText("multi.processed");c.push(h);}else{if(B.response){h.message=JSON.parse(B.response.body).error.message.value;f.push(h);}}}if(s)s(c,f,r);};var E=function(b){t.fnShowReleaseLoader(false);t.oDataRequestFailed(b);if(e)e(b);};t.oModel.setRefreshAfterChange(false);t.fireBatch({aPaths:R,aUrlParameters:p,sMethod:"POST",sBatchGroupId:"massResubmit",numberOfRequests:R.length,fnSuccessCallback:S,fnErrorCallback:E});},searchUsers:function(o,s,m,S){this.fnShowLoaderInDialogs(true);var t=this;var p={SAP__Origin:"'"+o+"'",SearchPattern:"'"+s+"'",MaxResults:m};this.oDataRead("/SearchUsers",p,function(d,r){t.fnShowLoaderInDialogs(false);if(d&&d.results){if(S){S(d.results);}}},function(e){t.fnShowLoaderInDialogs(false);t.oDataRequestFailed(e);});},_performPost:function(p,o,u,s,e,E){this.oDataCreate(p,o,u,undefined,undefined,$.proxy(function(d,r){$.sap.log.info("successful action");if(s){$.proxy(s(d,r),this);}},this),$.proxy(function(a){if(E){var d=this.getErrorMessage(a);var a={customMessage:{message:E,details:d}};}else{var d=this.getErrorMessage(a);var a={customMessage:{message:a.message,details:d}};a.customMessage.details=d;}this.oDataRequestFailed(a,e);},this));},oDataRequestFailed:function(e,E){var m;var d;if(e.hasOwnProperty("customMessage")){m=e.customMessage.message;d=e.customMessage.details;}else{if(e.response&&e.response.statusCode=="0"){m=this.oi18nResourceBundle.getText("DataManager.connectionError");}else{m=this.oi18nResourceBundle.getText("DataManager.HTTPRequestFailed");}if(e.response&&e.response.body!=""&&e.response.statusCode=="400"){var p=JSON.parse(e.response.body);d=p.error.message.value;}else{d=e.response?e.response.body:null;}}var P={message:m,responseText:d};this.showLocalErrorMessage(P,E);this.oModel.fireRequestFailed(P);},oDataRead:function(p,u,s,e){this.oModel.read(p,{urlParameters:u,success:s,error:e});},oDataCreate:function(p,o,u,d,c,s,e){var S={context:c,success:s,error:e,urlParameters:u};this.oPostActionModel.create(p,d,S);},oDataAddOperationsAndSubmitBatch:function(r,c,s,e,a){this.oPostActionModel.clearBatch();if(r)this.oPostActionModel.addBatchReadOperations(r);if(c){for(var i=0;i<c.length;i++)this.oPostActionModel.addBatchChangeOperations([c[i]]);}this.oPostActionModel.submitBatch(s,e,a);},oDataConvertHeaders:function(c,h){for(var H in h){if(H!==c&&H.toLowerCase()===c.toLowerCase()){var o=h[H];delete h[H];h[c]=o;break;}}},addComment:function(s,i,c,S,e,C){var u={SAP__Origin:"'"+s+"'",InstanceID:"'"+i+"'",Text:"'"+c+"'"};C.fnShowLoaderForComments(true);this._performPost("/AddComment",s,u,$.proxy(function(d,r){if(S){C.fnShowLoaderForComments(false);S(d,r);}},this),$.proxy(function(E){C.fnShowLoaderForComments(false);if(e){e(E);}},this),this.oi18nResourceBundle.getText("dialog.error.addComment"));},_createSubstitutionRule:function(a,p,s,e){var r=[];var P=[];var b=[];var t=this;jQuery.each(p,function(i,c){var T={};T=jQuery.extend(true,{},a);T.SAP__Origin=c;r.push("/SubstitutionRuleCollection");P.push("");b.push(T);});var S=function(d){t.fnShowReleaseLoader(false);var B=d.__batchResponses;var c=[];var f=[];jQuery.each(B,function(i,o){var h=false;if(o.hasOwnProperty("__changeResponses")){var C=o.__changeResponses[0];if(C.statusCode>="200"&&C.statusCode<"300")h=true;}if(h){c.push(i);}else{f.push(o);}});if(f.length>0){var g=c.length>0?t.oi18nResourceBundle.getText("substn.create.multi.error"):t.oi18nResourceBundle.getText("substn.create.error");t._handleBatchErrors(f,g);}if(s){s(c,f);}t.fnShowReleaseLoader(false);};var E=function(o){t.fnShowReleaseLoader(false);t.oDataRequestFailed(o);if(e){e(o);}};t.fnShowReleaseLoader(true);t.fireBatch({aPaths:r,aUrlParameters:P,sMethod:"POST",sBatchGroupId:"CreateSubstitutionRule",numberOfRequests:r.length,fnSuccessCallback:S,fnErrorCallback:E,aProperties:b});},showLocalErrorMessage:function(e,E){var s={type:sap.ca.ui.message.Type.ERROR,message:e.message,details:e.responseText};this.showMessageBox(s,E);},showMessageBox:function(s,e){sap.ca.ui.message.showMessageBox(s,e);},readSubstitutionData:function(s){var t=this;var r=[];var p=[];r.push("/SubstitutionRuleCollection");p.push("");if(!this.aSystemInfoCollection){r.push("/SystemInfoCollection");p.push("");}if(!this.aSubstitutionProfilesCollection){r.push("/SubstitutionProfileCollection");p.push("");}var S=function(d){if(d.hasOwnProperty("__batchResponses")&&d.__batchResponses.length>=1){var E=[];if(d.__batchResponses.length==3){var o=d.__batchResponses[2];if(!(E.length>0)&&o.hasOwnProperty("data")&&o.statusCode>='200'&&o.statusCode<'300'){t.aSubstitutionProfilesCollection=o.data.results;}else if(o.hasOwnProperty("response")&&o.response.statusCode>='400'){E.push(JSON.parse(o.response.body));}var a=d.__batchResponses[1];if(!(E.length>0)&&a.hasOwnProperty("data")&&a.statusCode>='200'&&a.statusCode<'300'){t.aSystemInfoCollection=a.data.results;}else if(a.hasOwnProperty("response")&&a.response.statusCode>='400'){E.push(JSON.parse(a.response.body));}}var b=d.__batchResponses[0];if(!(E.length>0)&&b.hasOwnProperty("data")&&b.statusCode>='200'&&b.statusCode<'300'){s(b.data,t.aSubstitutionProfilesCollection,t.aSystemInfoCollection);}else if(b.hasOwnProperty("response")&&b.response.statusCode>='400'){E.push(JSON.parse(b.response.body));}t.fnShowReleaseLoader(false);t._handleBatchErrors(E);}};var e=function(E){t.fnShowReleaseLoader(false);t.oDataRequestFailed(E);};t.fnShowReleaseLoader(true);t.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"GET",sBatchGroupId:"SubstitutionData",numberOfRequests:r.length,fnSuccessCallback:S,fnErrorCallback:e});},updateSubstitutionRule:function(a,e,s,E){var r=[];var p=[];var t=this;var u=cross.fnd.fiori.inbox.Substitution.formatterSubstitutedUserName(a.User,a.FullName);var R=e?a.aDisabledRules:a.aEnabledRules;for(var i=0;i<R.length;i++){var I=R[i];var P="/"+t.FUNCTION_IMPORT_ENABLESUBSTITUTIONRULE;var o={SubstitutionRuleID:"'"+I.subRuleId+"'",SAP__Origin:"'"+I.sOrigin+"'",Enabled:e};r.push(P);p.push(o);};var S=function(d){var b=[];var c=[];var B=d.__batchResponses;var m;jQuery.each(B,function(g,h){var j=false;if(h.hasOwnProperty("__changeResponses")){var C=h.__changeResponses[0];if(C.statusCode>="200"&&C.statusCode<"300"){c.push(g);j=true;}}if(!j){b.push(h);}});if(c.length>0&&b.length===0){jQuery.sap.delayedCall(500,t,function(){m=e?t.oi18nResourceBundle.getText("addInbox.enable.rule.success",u):t.oi18nResourceBundle.getText("addInbox.disable.rule.success",u);sap.ca.ui.message.showMessageToast(m);});}else{if(c.length===0){m=t.oi18nResourceBundle.getText("addInbox.action.error");}else{m=e?t.oi18nResourceBundle.getText("addInbox.enable.rule.partial.success",u):t.oi18nResourceBundle.getText("addInbox.disable.rule.partial.success",u);}}t._handleBatchErrors(b,m);if(s){s(c.length);}};var f=function(d){var D=t.getErrorMessage(b);var b={customMessage:{message:t.oi18nResourceBundle.getText("addInbox.action.error"),details:D}};t.oDataRequestFailed(b);if(E){E();}};t.fireBatch({aPaths:r,aUrlParameters:p,sMethod:"POST",sBatchGroupId:"updateSubstitution",numberOfRequests:r.length,fnSuccessCallback:S,fnErrorCallback:f});},deleteAttachment:function(s,i,a,S,e){var t=this;var p="/AttachmentCollection(SAP__Origin='"+jQuery.sap.encodeURL(s)+"',InstanceID='"+jQuery.sap.encodeURL(i)+"',ID='"+jQuery.sap.encodeURL(a)+"')/$value";var r=[];r.push(p);var f=function(){t.processListAfterAction(s,i);S();};var E=function(){e();};this.fireBatch({aPaths:r,aUrlParameters:"",sMethod:"DELETE",sBatchGroupId:"DeleteAttachment",numberOfRequests:r.length,fnSuccessCallback:f,fnErrorCallback:E});},deleteSubstitution:function(r,s){var t=this;this.fnShowReleaseLoader(true);if(r.length===1){var u={SubstitutionRuleID:"'"+r[0].SubstitutionRuleId+"'",SAP__Origin:"'"+r[0].SAP__Origin+"'"};var e=function(){t.fnShowReleaseLoader(false);};var S=function(d){t.fnShowReleaseLoader(false);s(d);};this._performPost("/DeleteSubstitutionRule",r[0].SAP__Origin,u,S,e,this.oi18nResourceBundle.getText("substn.delete.error"));}else if(r.length>1){var R=[];var p=[];jQuery.each(r,$.proxy(function(i,o){var a=this.getDeleteSubtnEntry(o);R.push(a.rule);p.push(a.parameters);},this));var S=function(d){t.fnShowReleaseLoader(false);var b=d.__batchResponses;var a=[];var c=[];var D="";jQuery.each(b,function(i,B){var g=false;if(B.hasOwnProperty("__changeResponses")){var C=B.__changeResponses[0];if(C.statusCode>="200"&&C.statusCode<"300"){a.push(i);g=true;}}if(!g){c.push(B);}});if(a.length>0){s(a,c);}if(c.length>0){var f=a.length>0?this.oi18nResourceBundle.getText("substn.delete.multi.error"):this.oi18nResourceBundle.getText("substn.delete.error");this._handleBatchErrors(c,f);}};var E=function(o){t.fnShowReleaseLoader(false);var d=this.getErrorMessage(o);var o={customMessage:{message:this.oi18nResourceBundle.getText("substn.delete.error"),details:d}};this.oDataRequestFailed(o);};t.fireBatch({aPaths:R,aUrlParameters:p,sMethod:"FUNCTIONIMPORT",sBatchGroupId:"DeleteSubstitution",numberOfRequests:R.length,fnSuccessCallback:S,fnErrorCallback:E});}},getDeleteSubtnEntry:function(r){return{rule:"/DeleteSubstitutionRule",parameters:{SubstitutionRuleID:r.SubstitutionRuleId,SAP__Origin:r.SAP__Origin}};},getErrorMessage:function(E){if(E.response&&E.response.body&&E.response.body!=""){try{var m=JSON.parse(E.response.body);return(m.error.message.value?m.error.message.value:null);}catch(e){return E.response.body;}}else if(E.responseText&&E.responseText!=""){try{var m=JSON.parse(E.responseText);return(m.error.message.value?m.error.message.value:null);}catch(e){return E.responseText;}}else if(E.getParameter("responseText")||E.getParameter("response").body){return E.getParameter("responseText")?E.getParameter("responseText"):E.getParameter("response").body;}else{return null;}},readSubstitutionProfiles:function(o,a){if(this.aSubstitutionProfilesCollection){if(o){o(this.aSubstitutionProfilesCollection);}return;}var t=this;t.fnShowReleaseLoader(true);this.oDataRead("/SubstitutionProfileCollection",null,function(d,r){t.fnShowReleaseLoader(false);if(d&&d.results){if(o){o(d.results);}}},function(e){t.fnShowReleaseLoader(false);t.oDataRequestFailed(e);if(a){a(e);}});},readSystemInfoCollection:function(o,a){if(this.aSystemInfoCollection){if(o){o(this.aSystemInfoCollection);}return;}var t=this;t.fnShowReleaseLoader(true);this.oDataRead("/SystemInfoCollection",null,function(d,r){t.fnShowReleaseLoader(false);if(d&&d.results){if(o){o(d.results);}}},function(e){t.fnShowReleaseLoader(false);t.oDataRequestFailed(e);if(a){a(e);}});},readTaskDefinitionCollection:function(o,a){var t=this;t.fnShowReleaseLoader(true);this.oDataRead("/TaskDefinitionCollection",null,function(d,r){t.fnShowReleaseLoader(false);if(d&&d.results){if(o){o(d.results);}}},function(e){t.fnShowReleaseLoader(false);t.oDataRequestFailed(e);if(a){a(e);}});},fnRefreshSingleTaskData:function(o,i){var t=this;var c=this._getTaskContextPath(o,i);var s=function(d){t.fireItemRemoved();$.sap.log.info("successfully updated odata model");};var e=function(E){t.oDataRequestFailed(E);};this.oDataRead(c,null,jQuery.proxy(s,t),e);},fnGetDataWithCountSupport:function(v,o,i,g,s,e){var t=this;var l="";if(!g){switch(e){case"Attachments":l="uploadCollection";break;case"TaskObjects":l="MIBObjectLinksList";break;case"ProcessingLogs":l="timeline";break;default:break;}}var c=g?"/$count":"";var C=this._getTaskContextPath(o,i)+"/"+e+c;var E=function(a){if(!g)t.fnShowLoaderInDetailControls(v,l,false);t.oDataRequestFailed(a);};if(!g)t.fnShowLoaderInDetailControls(v,l,true);this.oDataRead(C,null,function(d){if(!g)t.fnShowLoaderInDetailControls(v,l,false);s(d);},E);},fnReadCommentsAndCreatedByDetails:function(p,P,s,c){c.fnShowLoaderForComments(true);var t=this;var e=function(E){c.fnShowLoaderForComments(false);t.oDataRequestFailed(E);};var S=function(d){c.fnShowLoaderForComments(false);s(d);};t.oDataRead(p,P,S,e);},updateTaskAfterAddAction:function(i,n,u){var e=function(E){jQuery.sap.log.error("Error while updating task detail");};var p=[];var t=this._getTaskContextPath(i.SAP__Origin,i.InstanceID);p.push(t+"/"+n+"/$count");if(i.TaskSupports.ProcessingLogs){p.push(t+"/ProcessingLogs/$count");}this.fireBatch({aPaths:p,sMethod:"GET",sBatchGroupId:"processAddComments",numberOfRequests:p.length,fnSuccessCallback:u,fnErrorCallback:e});},_getTaskContextPath:function(o,i){return"/"+"TaskCollection"+"(SAP__Origin='"+jQuery.sap.encodeURL(o)+"',InstanceID='"+jQuery.sap.encodeURL(i)+"')";},fnIsImagePresent:function(u){var i=false;jQuery.ajax({url:u,type:'GET',contentType:'image/jpeg',async:false,success:function(d,s,j){if(d!=""){i=true;}},error:function(d,t,c){i=false;}});return i;},fnShowReleaseLoader:function(v){var t=this;var s=function(){t.detailPage.setBusyIndicatorDelay(0);t.detailPage.setBusy(v);var l=t.oListView.byId("list");if(l){if(v)l.setEnableBusyIndicator(false);else l.setEnableBusyIndicator(true);}t.oListView.setBusyIndicatorDelay(0);t.oListView.setBusy(v);};if(!v&&this.detailPage&&this.oListView&&this.bDetailPageLoaded){s();}if(v&&this.detailPage&&this.oListView){s();}if(this.oSubstitutionView){this.oSubstitutionView.setBusyIndicatorDelay(0);this.oSubstitutionView.setBusy(v);}},fnShowLoaderInDetailControls:function(v,i,s){if(this.detailPage){if(!this.detailPage.byId(i)&&v.byId(i)){v.byId(i).setBusyIndicatorDelay(0);v.byId(i).setBusy(s);}else{this.detailPage.byId(i).setBusyIndicatorDelay(0);this.detailPage.byId(i).setBusy(s);}}},fnShowLoaderInDialogs:function(v){if(this.oForwardView&&this.oForwardView.byId("DLG_FORWARD")){this.oForwardView.byId("DLG_FORWARD").setBusyIndicatorDelay(0);this.oForwardView.byId("DLG_FORWARD").setBusy(v);}if(this.oSubstitutionView&&this.oSubstitutionFragment){this.oSubstitutionFragment.setBusyIndicatorDelay(0);this.oSubstitutionFragment.setBusy(v);}},_refreshListOnError:function(o,i){this.oModel.bFullRefreshNeeded=true;jQuery.sap.delayedCall(500,this,function(){sap.ca.ui.message.showMessageToast(this.oi18nResourceBundle.getText("dialog.info.task_completed"));});if(sap.ui.Device.system.phone){this.oBaseController.sBindingContextPath=undefined;this.oBaseController.oRouter.navTo("master",{},true);}else{this.oBaseController.findNextVisibleItem(o,i);}this.oModel.refresh();},checkStatusAndOpenTask:function(o,i,O){var t=this;var e=function(){t._refreshListOnError(o,i);};var s=function(d){if(d.hasOwnProperty("__batchResponses")&&d.__batchResponses.length>0){var S=d.__batchResponses[0];if(S.hasOwnProperty("data")&&S.statusCode>='200'&&S.statusCode<'300'){if(!(S.data.Status===t.sStatusCompleted)&&(t.bOutbox==false)){O();return;}else if(t.bOutbox==true){O();return;}}}e();};this.fireBatch({aPaths:[this._getTaskContextPath(o,i)],aUrlParameters:[{$select:"Status"}],sMethod:"GET",sBatchGroupId:"GetLatestStatus",numberOfRequests:1,fnSuccessCallback:s,fnErrorCallback:e});},readAddInboxUsers:function(s,e){var t=this;this.oDataRead("/SubstitutesRuleCollection",null,function(d,r){if(d){if(s){s(d);}}},function(E){e();t.fnShowReleaseLoader(false);var d=t.getErrorMessage(E);var E={customMessage:{message:t.oi18nResourceBundle.getText("addInbox.read.error"),details:d}};t.oDataRequestFailed(E);});},readSubstitutedUserList:function(s,e){var t=this;this.oDataRead("/SubstitutedUsersCollection",null,function(d,r){if(d&&s){s(d);}},function(E){e();t.fnShowReleaseLoader(false);var d=t.getErrorMessage(E);var E={customMessage:{message:t.oi18nResourceBundle.getText("substitutesUser.read.error"),details:d}};t.oDataRequestFailed(E);});},refreshListOnAddInboxDone:function(e){this.oModel.bFullRefreshNeeded=true;this.oModel.refresh();},handleMetadataFailed:function(e){var d=this.getErrorMessage(e);var e={customMessage:{message:this.oi18nResourceBundle.getText("DataManager.metadataFailed"),details:d}};this.oDataRequestFailed(e);},checkImageAvailabilityAsync:function(u,s,e){jQuery.ajax({url:u,type:'GET',contentType:'image/jpeg',async:true,success:function(d,a,j){if(d!=""){s();}else{e();}},error:function(d,t,c){e();}});},fetchUIExecutionLink:function(c,s){var t=this;if(t.detailPage){t.detailPage.setBusyIndicatorDelay(0);t.detailPage.setBusy(true);};this.oDataRead(c+"/UIExecutionLink",null,function(d){t.fnShowReleaseLoader(false);s(d);},function(){t.fnShowReleaseLoader(false);});}});cross.fnd.fiori.inbox.util.DataManager.M_EVENTS={ItemRemoved:"itemRemoved"};
